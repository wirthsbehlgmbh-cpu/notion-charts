<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notion Chart ‚Äì Setup</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap');

:root {
  --bg:      #0f0f13;
  --s1:      #17171d;
  --s2:      #1e1e26;
  --s3:      #26262f;
  --border:  #2c2c38;
  --border2: #38384a;
  --acc:     #5e6ad2;
  --acc-g:   rgba(94,106,210,0.2);
  --acc3:    #3dbf8c;
  --text:    #e8e8f2;
  --text2:   #7e7e9a;
  --text3:   #4e4e66;
  --red:     #e15555;
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'DM Sans',sans-serif;
  background:var(--bg); color:var(--text);
  min-height:100vh;
}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar {
  display:flex; align-items:center; gap:14px;
  padding:0 32px; height:58px;
  border-bottom:1px solid var(--border);
  background:rgba(15,15,19,.9);
  backdrop-filter:blur(12px);
  position:sticky; top:0; z-index:100;
}
.brand { display:flex; align-items:center; gap:9px; font-weight:700; font-size:15px; }
.brand-dot {
  width:28px; height:28px; border-radius:7px;
  background:linear-gradient(135deg,var(--acc),#8b94e8);
  display:flex; align-items:center; justify-content:center; font-size:14px;
}
.tag { font-size:11px; color:var(--acc3); border:1px solid var(--acc3); padding:2px 8px; border-radius:100px; opacity:.7; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.page { display:grid; grid-template-columns:1fr 1fr; gap:0; min-height:calc(100vh - 58px); }

/* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
.left { padding:32px; border-right:1px solid var(--border); overflow-y:auto; }
.right { padding:32px; display:flex; flex-direction:column; gap:24px; }

/* ‚îÄ‚îÄ STEP HEADERS ‚îÄ‚îÄ */
.step {
  display:flex; align-items:center; gap:10px;
  font-size:10px; font-weight:700; letter-spacing:1.4px; text-transform:uppercase;
  color:var(--text3); margin-bottom:16px;
}
.step-num {
  width:20px; height:20px; border-radius:50%;
  background:var(--s3); border:1px solid var(--border2);
  display:flex; align-items:center; justify-content:center;
  font-size:10px; color:var(--text2); flex-shrink:0;
}
.step::after { content:''; flex:1; height:1px; background:var(--border); }

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card {
  background:var(--s1); border:1px solid var(--border);
  border-radius:10px; padding:20px; margin-bottom:20px;
}
.card-title { font-size:13px; font-weight:600; margin-bottom:14px; }

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.field { margin-bottom:14px; }
.field:last-child { margin-bottom:0; }
label { display:block; font-size:11px; font-weight:600; color:var(--text2); margin-bottom:5px; letter-spacing:.3px; }
.label-hint { font-size:10px; color:var(--text3); font-weight:400; margin-left:6px; }
input, select {
  width:100%; background:var(--s2); border:1px solid var(--border2);
  color:var(--text); padding:9px 12px; border-radius:7px;
  font-family:'DM Mono',monospace; font-size:12px; outline:none;
  transition:border-color .18s, box-shadow .18s;
}
input:focus, select:focus { border-color:var(--acc); box-shadow:0 0 0 3px var(--acc-g); }
select option { background:var(--s2); }
input[type=password] { letter-spacing:2px; }

.row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }

/* ‚îÄ‚îÄ TOGGLE GROUP ‚îÄ‚îÄ */
.tog-group { display:flex; gap:5px; flex-wrap:wrap; }
.tog {
  padding:5px 10px; font-size:11px; font-weight:600;
  background:var(--s2); border:1.5px solid var(--border);
  color:var(--text3); border-radius:6px; cursor:pointer; transition:all .15s;
  font-family:'DM Mono',monospace;
}
.tog:hover { color:var(--text2); border-color:var(--border2); }
.tog.on { background:rgba(94,106,210,.12); border-color:var(--acc); color:var(--acc); }

/* ‚îÄ‚îÄ INFO BOX ‚îÄ‚îÄ */
.infobox {
  background:rgba(94,106,210,.07); border:1px solid rgba(94,106,210,.2);
  border-radius:8px; padding:12px 14px;
  font-size:12px; color:var(--text2); line-height:1.75;
}
.infobox a { color:var(--acc); text-decoration:none; }
.infobox a:hover { text-decoration:underline; }
.infobox strong { color:var(--text); }
.infobox ol { padding-left:16px; }
.infobox li { margin-bottom:4px; }
code {
  background:var(--s3); border:1px solid var(--border);
  padding:1px 6px; border-radius:4px;
  font-size:11px; font-family:'DM Mono',monospace; color:var(--acc3);
}

/* ‚îÄ‚îÄ BTN ‚îÄ‚îÄ */
.btn {
  font-family:'DM Sans',sans-serif; font-size:13px; font-weight:600;
  padding:10px 18px; border-radius:8px; border:none;
  cursor:pointer; display:inline-flex; align-items:center; gap:7px; transition:all .18s;
}
.btn-pri { background:var(--acc); color:#fff; box-shadow:0 2px 12px var(--acc-g); }
.btn-pri:hover { background:#6e7de0; transform:translateY(-1px); box-shadow:0 4px 18px var(--acc-g); }
.btn-ghost { background:transparent; border:1px solid var(--border2); color:var(--text2); }
.btn-ghost:hover { background:var(--s2); color:var(--text); }
.btn-full { width:100%; justify-content:center; }

/* ‚îÄ‚îÄ URL OUTPUT ‚îÄ‚îÄ */
.url-box {
  background:var(--s2); border:1px solid var(--border2);
  border-radius:8px; padding:12px 14px;
  font-family:'DM Mono',monospace; font-size:11px;
  color:var(--acc3); word-break:break-all; line-height:1.7;
  max-height:100px; overflow-y:auto; min-height:48px;
}
.url-box.empty { color:var(--text3); font-style:italic; }

/* ‚îÄ‚îÄ COPY FEEDBACK ‚îÄ‚îÄ */
.copy-row { display:flex; gap:8px; align-items:center; }
.copy-badge {
  font-size:11px; color:var(--acc3); opacity:0;
  transition:opacity .3s; font-family:'DM Mono',monospace;
}
.copy-badge.show { opacity:1; }

/* ‚îÄ‚îÄ PREVIEW FRAME ‚îÄ‚îÄ */
.preview-wrap {
  border:1px solid var(--border); border-radius:10px; overflow:hidden;
  background:var(--s1); flex:1; min-height:300px;
}
.preview-bar {
  padding:8px 14px; background:var(--s2);
  border-bottom:1px solid var(--border);
  font-size:11px; color:var(--text2); font-family:'DM Mono',monospace;
  display:flex; align-items:center; justify-content:space-between;
}
.preview-bar span { display:flex; align-items:center; gap:6px; }
.prev-dot { width:6px; height:6px; border-radius:50%; background:var(--border2); }
.prev-dot.live { background:var(--acc3); box-shadow:0 0 6px var(--acc3); }
#preview-frame {
  width:100%; border:none; background:var(--bg);
  min-height:260px; display:block;
}

/* ‚îÄ‚îÄ STEPS GUIDE ‚îÄ‚îÄ */
.guide-step {
  display:flex; gap:12px; padding:12px 0;
  border-bottom:1px solid var(--border);
}
.guide-step:last-child { border-bottom:none; }
.guide-num {
  width:24px; height:24px; border-radius:50%; flex-shrink:0;
  background:var(--acc); color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:11px; font-weight:700; margin-top:1px;
}
.guide-text { font-size:12px; color:var(--text2); line-height:1.6; }
.guide-text strong { color:var(--text); }
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <div class="brand-dot">üìä</div>
    NotionCharts
  </div>
  <span class="tag">Embed-Konfigurator</span>
</header>

<div class="page">

  <!-- ‚ïê‚ïê‚ïê‚ïê LEFT: CONFIG ‚ïê‚ïê‚ïê‚ïê -->
  <div class="left">

    <!-- API -->
    <div class="step"><div class="step-num">1</div>Notion API verbinden</div>
    <div class="card">
      <div class="infobox" style="margin-bottom:14px;">
        <strong>Notion Integration Token erstellen:</strong>
        <ol>
          <li>√ñffne <a href="https://www.notion.so/my-integrations" target="_blank">notion.so/my-integrations</a></li>
          <li>Klicke <strong>+ New integration</strong>, benenne sie und speichere</li>
          <li>Kopiere den <strong>Internal Integration Token</strong> (<code>ntn_‚Ä¶</code>)</li>
          <li>√ñffne deine Datenbank in Notion ‚Üí <strong>‚ãØ ‚Üí Connections ‚Üí deine Integration</strong></li>
        </ol>
      </div>
      <div class="field">
        <label>Integration Token <span class="label-hint">(wird nur lokal gespeichert)</span></label>
        <input type="password" id="inp-key" placeholder="ntn_‚Ä¶ oder secret_‚Ä¶" autocomplete="off" oninput="update()" />
      </div>
      <div class="field">
        <label>Datenbank-ID <span class="label-hint">aus der Notion-URL</span></label>
        <input type="text" id="inp-db" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" oninput="update()" />
        <div style="font-size:10px;color:var(--text3);margin-top:4px;line-height:1.6;">
          URL-Format: notion.so/DEINE-SEITE/<strong style="color:var(--acc3);">DATENBANKID</strong>?v=‚Ä¶<br>
          Nur die 32-stellige ID ohne Bindestriche oder mit Bindestrichen einf√ºgen.
        </div>
      </div>
    </div>

    <!-- CHART CONFIG -->
    <div class="step"><div class="step-num">2</div>Chart konfigurieren</div>
    <div class="card">
      <div class="row2" style="margin-bottom:14px;">
        <div class="field" style="margin:0;">
          <label>Spalte: X-Achse / Labels</label>
          <input type="text" id="inp-x" placeholder="z. B. Datum" oninput="update()" />
        </div>
        <div class="field" style="margin:0;">
          <label>Spalte: Y-Achse / Werte</label>
          <input type="text" id="inp-y" placeholder="z. B. Betrag" oninput="update()" />
        </div>
      </div>
      <div class="row2" style="margin-bottom:14px;">
        <div class="field" style="margin:0;">
          <label>Gruppierung <span class="label-hint">(optional)</span></label>
          <input type="text" id="inp-g" placeholder="z. B. Kategorie" oninput="update()" />
        </div>
        <div class="field" style="margin:0;">
          <label>Aggregation</label>
          <select id="inp-agg" onchange="update()">
            <option value="sum">Summe</option>
            <option value="count">Anzahl</option>
            <option value="avg">Durchschnitt</option>
            <option value="min">Minimum</option>
            <option value="max">Maximum</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Chart-Typ</label>
        <div class="tog-group" id="type-group">
          <div class="tog on" data-val="line" onclick="setTog('type',this)">üìà Linie</div>
          <div class="tog"    data-val="bar"  onclick="setTog('type',this)">üìä Balken</div>
          <div class="tog"    data-val="pie"  onclick="setTog('type',this)">ü•ß Kreis</div>
        </div>
      </div>
      <div class="field" id="bardir-field" style="display:none;">
        <label>Balken-Richtung</label>
        <div class="tog-group" id="bardir-group">
          <div class="tog on" data-val="vertical"   onclick="setTog('bardir',this)">Vertikal</div>
          <div class="tog"    data-val="horizontal" onclick="setTog('bardir',this)">Horizontal</div>
        </div>
      </div>
    </div>

    <!-- ADVANCED -->
    <div class="step"><div class="step-num">3</div>Erweiterte Optionen</div>
    <div class="card">
      <div class="row3" style="margin-bottom:14px;">
        <div class="field" style="margin:0;">
          <label>Max. Punkte</label>
          <input type="number" id="inp-max" value="20" min="1" max="500" oninput="update()" />
        </div>
        <div class="field" style="margin:0;">
          <label>Sortierung</label>
          <select id="inp-sort" onchange="update()">
            <option value="none">Standard</option>
            <option value="asc">‚Üë Aufsteigend</option>
            <option value="desc">‚Üì Absteigend</option>
          </select>
        </div>
        <div class="field" style="margin:0;">
          <label>Farbpalette</label>
          <select id="inp-pal" onchange="update()">
            <option value="0">Indigo</option>
            <option value="1">Sunset</option>
            <option value="2">Ocean</option>
            <option value="3">Gr√ºn</option>
            <option value="4">Mono</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Filter <span class="label-hint">Spaltenname:Wert</span></label>
        <input type="text" id="inp-filter" placeholder="z. B. Status:Aktiv" oninput="update()" />
      </div>
      <div class="field">
        <label>Chart-Titel <span class="label-hint">(optional)</span></label>
        <input type="text" id="inp-title" placeholder="z. B. Kontostand 2024" oninput="update()" />
      </div>
      <div class="field">
        <label>Optionen</label>
        <div class="tog-group">
          <div class="tog on" id="tog-cumul" onclick="toggleFlag('cumul')">‚àë Kumulativ</div>
          <div class="tog on" id="tog-dark"  onclick="toggleFlag('dark')">üåô Dark Mode</div>
        </div>
      </div>
      <div class="field">
        <label>CORS-Proxy <span class="label-hint">(f√ºr Browser-Anfragen n√∂tig)</span></label>
        <input type="text" id="inp-proxy" value="https://corsproxy.io/?" oninput="update()" />
      </div>
    </div>

  </div><!-- /left -->

  <!-- ‚ïê‚ïê‚ïê‚ïê RIGHT: OUTPUT ‚ïê‚ïê‚ïê‚ïê -->
  <div class="right">

    <!-- URL Output -->
    <div>
      <div class="step" style="margin-bottom:12px;"><div class="step-num">4</div>Embed-URL generieren &amp; kopieren</div>
      <div class="url-box empty" id="url-out">‚Üê F√ºlle die Felder links aus, um die URL zu generieren.</div>
      <div class="copy-row" style="margin-top:10px;">
        <button class="btn btn-pri" onclick="copyUrl()" id="copy-btn" disabled>üìã URL kopieren</button>
        <button class="btn btn-ghost" onclick="openPreview()" id="open-btn" disabled>‚Üó Vorschau √∂ffnen</button>
        <span class="copy-badge" id="copy-badge">‚úì Kopiert!</span>
      </div>
    </div>

    <!-- Notion instructions -->
    <div class="card" style="margin-bottom:0;">
      <div class="card-title">üìå In Notion einf√ºgen</div>
      <div class="guide-step">
        <div class="guide-num">1</div>
        <div class="guide-text">Kopiere die generierte URL oben mit dem Button <strong>URL kopieren</strong></div>
      </div>
      <div class="guide-step">
        <div class="guide-num">2</div>
        <div class="guide-text">√ñffne deine Notion-Seite und tippe <code>/embed</code> in einer leeren Zeile</div>
      </div>
      <div class="guide-step">
        <div class="guide-num">3</div>
        <div class="guide-text">F√ºge die URL in das Embed-Feld ein und klicke <strong>Embed erstellen</strong></div>
      </div>
      <div class="guide-step">
        <div class="guide-num">4</div>
        <div class="guide-text">Ziehe den Embed-Block an den R√§ndern auf die gew√ºnschte Gr√∂√üe</div>
      </div>
    </div>

    <!-- GitHub hosting notice -->
    <div class="infobox">
      <strong>üöÄ Hosting auf GitHub Pages (kostenlos, 2 Min.):</strong><br>
      Notion kann nur URLs einbetten, die √∂ffentlich im Internet erreichbar sind.<br><br>
      <ol>
        <li>Erstelle ein neues Repository auf <a href="https://github.com/new" target="_blank">github.com/new</a></li>
        <li>Lade die beiden Dateien <code>chart.html</code> und <code>setup.html</code> hoch</li>
        <li>Gehe zu <strong>Settings ‚Üí Pages ‚Üí Branch: main ‚Üí Save</strong></li>
        <li>Deine URL lautet: <code>https://DEIN-NAME.github.io/REPO/chart.html?‚Ä¶</code></li>
        <li>Diese URL mit den Parametern in Notion als Embed einf√ºgen ‚úÖ</li>
      </ol>
    </div>

    <!-- Live Preview -->
    <div>
      <div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;display:flex;align-items:center;gap:8px;">
        Lokale Vorschau <span style="font-size:9px;color:var(--text3);font-weight:400;">(funktioniert nur wenn chart.html im gleichen Ordner liegt)</span>
      </div>
      <div class="preview-wrap">
        <div class="preview-bar">
          <span><div class="prev-dot" id="prev-dot"></div><span id="prev-status">Keine URL generiert</span></span>
          <button class="btn btn-ghost" style="padding:3px 8px;font-size:10px;" onclick="refreshPreview()">‚Üª</button>
        </div>
        <iframe id="preview-frame" src="about:blank" height="280"></iframe>
      </div>
    </div>

  </div><!-- /right -->
</div>

<script>
const FLAGS = { cumul: true, dark: true };
const TOGS  = { type: 'line', bardir: 'vertical' };

function setTog(key, el) {
  TOGS[key] = el.dataset.val;
  el.closest('.tog-group').querySelectorAll('.tog').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('bardir-field').style.display = TOGS.type==='bar' ? 'block' : 'none';
  update();
}

function toggleFlag(key) {
  FLAGS[key] = !FLAGS[key];
  document.getElementById(`tog-${key}`).classList.toggle('on', FLAGS[key]);
  update();
}

function getBase() {
  // When hosted on GitHub Pages, this file (setup.html) is next to chart.html
  const base = window.location.href.replace(/\/[^/]*$/, '/chart.html');
  return base.startsWith('file:') ? 'chart.html' : base;
}

function update() {
  const key    = document.getElementById('inp-key').value.trim();
  const db     = document.getElementById('inp-db').value.trim().replace(/-/g,'');
  const x      = document.getElementById('inp-x').value.trim();
  const y      = document.getElementById('inp-y').value.trim();
  const g      = document.getElementById('inp-g').value.trim();
  const agg    = document.getElementById('inp-agg').value;
  const max    = document.getElementById('inp-max').value;
  const sort   = document.getElementById('inp-sort').value;
  const pal    = document.getElementById('inp-pal').value;
  const filter = document.getElementById('inp-filter').value.trim();
  const title  = document.getElementById('inp-title').value.trim();
  const proxy  = document.getElementById('inp-proxy').value.trim();

  const urlBox  = document.getElementById('url-out');
  const copyBtn = document.getElementById('copy-btn');
  const openBtn = document.getElementById('open-btn');

  if (!key || !db || !x) {
    urlBox.textContent = '‚Üê Mindestens Token, Datenbank-ID und X-Spalte ausf√ºllen.';
    urlBox.className = 'url-box empty';
    copyBtn.disabled = true;
    openBtn.disabled = true;
    return;
  }

  const p = new URLSearchParams();
  p.set('key', key);
  p.set('db', db);
  p.set('x', x);
  if (y)      p.set('y', y);
  if (g)      p.set('g', g);
  if (agg !== 'sum')  p.set('agg', agg);
  if (max !== '20')   p.set('max', max);
  if (sort !== 'none') p.set('sort', sort);
  if (pal !== '0')    p.set('pal', pal);
  if (filter)         p.set('filter', filter);
  if (title)          p.set('title', title);
  if (TOGS.type !== 'line')        p.set('type', TOGS.type);
  if (TOGS.bardir !== 'vertical')  p.set('bardir', TOGS.bardir);
  if (FLAGS.cumul)    p.set('cumul', '1');
  if (!FLAGS.dark)    p.set('theme', 'light');
  if (proxy !== 'https://corsproxy.io/?') p.set('proxy', proxy);

  const url = getBase() + '?' + p.toString();
  urlBox.textContent = url;
  urlBox.className = 'url-box';
  copyBtn.disabled = false;
  openBtn.disabled = false;
  window._currentUrl = url;

  // auto-refresh preview
  refreshPreview();
}

function copyUrl() {
  if (!window._currentUrl) return;
  navigator.clipboard.writeText(window._currentUrl).then(() => {
    const badge = document.getElementById('copy-badge');
    badge.classList.add('show');
    setTimeout(() => badge.classList.remove('show'), 2000);
  });
}

function openPreview() {
  if (window._currentUrl) window.open(window._currentUrl, '_blank');
}

function refreshPreview() {
  if (!window._currentUrl) return;
  const frame = document.getElementById('preview-frame');
  // Only auto-preview for file:// or same-origin (local testing)
  if (window.location.protocol === 'file:' || window.location.hostname === 'localhost') {
    frame.src = window._currentUrl;
    document.getElementById('prev-dot').className = 'prev-dot live';
    document.getElementById('prev-status').textContent = 'Vorschau aktiv';
  } else {
    // On GitHub Pages, iframe same origin works
    frame.src = window._currentUrl;
    document.getElementById('prev-dot').className = 'prev-dot live';
    document.getElementById('prev-status').textContent = 'Vorschau aktiv';
  }
}

// Init bardir visibility
document.getElementById('bardir-field').style.display = 'none';
</script>
</body>
</html>
